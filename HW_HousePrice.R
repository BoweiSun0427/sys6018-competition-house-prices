library(readr)
library(dplyr)
library(tidyverse)
library(FNN)

options("max.print" = 10000000)
# Load Data ---------------------------------------------------------------
train <- read.csv("train.csv")
test <- read.csv("test.csv")

missing_value = data.frame(matrix(ncol = 2, nrow = 81))
names(missing_value) = c("colName","MissingValue")

#cleaning data - find columns with missing value
#conbine train and test data once and do the cleaning at once.
test['SalePrice'] <- 0
train_test <- rbind(train,test)

for (i in 1:81){
  temp = as.data.frame(table(is.na(train_test[,i])))
  missing_value[i,] <- temp[2,2]
  missing_value[i,1] <- colnames(train_test[i])
}
missing_value <- filter(missing_value, missing_value$MissingValue != 'NA')
missing_value$colName
# [1] "MSZoning"     "LotFrontage"  "Alley"        "Utilities"    "Exterior1st"  "Exterior2nd" 
# [7] "MasVnrType"   "MasVnrArea"   "BsmtQual"     "BsmtCond"     "BsmtExposure" "BsmtFinType1"
# [13] "BsmtFinSF1"   "BsmtFinType2" "BsmtFinSF2"   "BsmtUnfSF"    "TotalBsmtSF"  "Electrical"  
# [19] "BsmtFullBath" "BsmtHalfBath" "KitchenQual"  "Functional"   "FireplaceQu"  "GarageType"  
# [25] "GarageYrBlt"  "GarageFinish" "GarageCars"   "GarageArea"   "GarageQual"   "GarageCond"  
# [31] "PoolQC"       "Fence"        "MiscFeature"  "SaleType" 

#recode missing values 
#recode with most common
train_test$MSZoning[is.na(train_test$MSZoning)] <- names(which.max(table(train_test$MSZoning)))
train_test$Utilities[is.na(train_test$Utilities)] <- names(which.max(table(train_test$Utilities))) 
train_test$Exterior1st[is.na(train_test$Exterior1st)] <- names(which.max(table(train_test$Exterior1st)))
train_test$Exterior2nd[is.na(train_test$Exterior2nd)] <- names(which.max(table(train_test$Exterior2nd)))
train_test$MasVnrType[is.na(train_test$MasVnrType)] <- names(which.max(table(train_test$MasVnrType)))
train_test$Electrical[is.na(train_test$Electrical)] <- names(which.max(table(train_test$Electrical)))
train_test$BsmtFullBath[is.na(train_test$BsmtFullBath)] <- names(which.max(table(train_test$BsmtFullBath)))
train_test$BsmtHalfBath[is.na(train_test$BsmtHalfBath)] <- names(which.max(table(train_test$BsmtHalfBath)))
train_test$KitchenQual[is.na(train_test$KitchenQual)] <- names(which.max(table(train_test$KitchenQual)))
train_test$Functional[is.na(train_test$Functional)] <- names(which.max(table(train_test$Functional)))
train_test$FireplaceQu[is.na(train_test$FireplaceQu)] <- names(which.max(table(train_test$FireplaceQu)))
train_test$GarageType[is.na(train_test$GarageType)] <- names(which.max(table(train_test$GarageType)))
train_test$GarageYrBlt[is.na(train_test$GarageYrBlt)] <- names(which.max(table(train_test$GarageYrBlt)))
train_test$GarageCars[is.na(train_test$GarageCars)] <- names(which.max(table(train_test$GarageCars)))
train_test$SaleType[is.na(train_test$SaleType)] <- names(which.max(table(train_test$SaleType)))

#recode with mean value
train_test$LotFrontage[is.na(train_test$LotFrontage)] <- mean(train_test$LotFrontage, na.rm = TRUE)
train_test$MasVnrArea[is.na(train_test$MasVnrArea)] <- mean(train_test$MasVnrArea, na.rm = TRUE)
train_test$BsmtFinSF1[is.na(train_test$BsmtFinSF1)] <- mean(train_test$BsmtFinSF1, na.rm = TRUE)
train_test$BsmtUnfSF[is.na(train_test$BsmtUnfSF)] <- mean(train_test$BsmtUnfSF, na.rm = TRUE)
train_test$TotalBsmtSF[is.na(train_test$TotalBsmtSF)] <- mean(train_test$TotalBsmtSF, na.rm = TRUE)
train_test$GarageArea[is.na(train_test$GarageArea)] <- mean(train_test$GarageArea, na.rm = TRUE)
train_test$BsmtFinSF2[is.na(train_test$BsmtFinSF2)] <- mean(train_test$BsmtFinSF2, na.rm = TRUE)

#NA to "none"
train_test[, c(7,31,32,33,34,36,61,64,65,73,74,75)] <-  lapply(train_test[, c(7,31,32,33,34,36,61,64,65,73,74,75)], as.character)
train_test[, c(7,31,32,33,34,36,61,64,65,73,74,75)][is.na(train_test[, c(7,31,32,33,34,36,61,64,65,73,74,75)])] <- "None"
train_test[, c(7,31,32,33,34,36,61,64,65,73,74,75)] <-  lapply(train_test[, c(7,31,32,33,34,36,61,64,65,73,74,75)], as.factor)

#run the for loop again to check whether clearning is done
for (i in 1:81){
  temp = as.data.frame(table(is.na(train_test[,i])))
  missing_value[i,] <- temp[2,2]
  missing_value[i,1] <- colnames(train_test[i])
}
missing_value <- filter(missing_value, missing_value$MissingValue != 'NA')
missing_value$colName

#split test_train into test AND train. cleaning is done here 
train <- filter(train_test, train_test$SalePrice != 0)
test <- filter(train_test, train_test$SalePrice == 0)

# #Parametric 
# train.lm <- lm(SalePrice ~ ., data =train)
# summary(train.lm)
# mse1 <- mean(train.lm$residuals^2)
# mse1
# #predict
# test.lm <- predict(train.lm, newdata=test)

##########################################
##########################################KNN
##########################################

#use only numeric cols
train_numeric <- select_if(train,is.numeric)
test_numeric <- select_if(test,is.numeric)

#By using cor(), here we decide what X variables will be added to KNN model.
cor(train_numeric)
#The following has the higest correlation between salePrice and it.
# c(5,17,24,13,14,18,22,7,8)
# OverallQual
# GrLivArea
# GarageArea
# TotalBsmtSF
# X1stFlrSF
# FullBath
# TotRmsAbvGrd
# YearBuilt
# YearRemodAdd

test_numeric['SalePrice'] <- NULL
train_numeric['SalePrice'] <- NULL

# calculate the number of K
k <- floor(sqrt(nrow(train_numeric)))

#nomalize
normalize <- function(x) {
  norm <- ((x - min(x))/(max(x) - min(x)))
  return (norm)
}

train_numeric[,2:33] <- apply(train_numeric[,2:33],2,normalize) 
test_numeric[,2:33] <- apply(test_numeric[,2:33],2,normalize) 

#Final selection
train_numeric <- train_numeric[, c(5,17,24,13,14,18,22,7,8)]
test_numeric <- test_numeric[, c(5,17,24,13,14,18,22,7,8)]

#
# function to calculate euclidean distance(reference: https://rpubs.com/bskc/300711)
euc.dist <- function(x1, x2) sqrt(sum((x1 - x2) ^ 2))
#
eist <- c()
distance <- c()

for (j in 1:1459) {
  for (i in 1:1460) {
    distance[i] <- euc.dist(train_numeric[i,],test_numeric[j,])

  }
  edist_temp <- data.frame(dist=distance, salePrice = train[,81])
  edist_temp <- edist_temp[order(edist_temp$dist),]
  edist_temp <- edist_temp[1:20,]
  distance_mean <- mean(edist_temp$salePrice)
  eist[j] <- distance_mean
}

#submission - export predictions 
final_result <- data_frame(test$Id)
final_result["salePrice"] <- eist
write.table(final_result, file = "submission.csv", row.names=F, col.names=c("Id","salePrice"), sep=",")



